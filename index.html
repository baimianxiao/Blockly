<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Blockly 开发环境</title>
    <!-- Blockly 核心库 -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <!-- Python 代码生成器 -->
    <script src="https://unpkg.com/blockly/python_compressed.js"></script>
    <!-- 中文语言包 -->
    <script src="https://unpkg.com/blockly/msg/zh-hans.js"></script>
    <style>
        #blocklyDiv {
            height: 600px;
            width: 800px;
            margin: 20px auto;
            border: 2px solid #ddd;
        }
        #codeOutput {
            width: 80%;
            margin: 20px auto;
            padding: 10px;
            background: #f5f5f5;
            border: 1px solid #ccc;
        }
        .toolbar {
            text-align: center;
            margin: 10px;
        }
        button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- 工作区容器 -->
    <div id="blocklyDiv"></div>
    
    <!-- 工具栏 -->
    <div class="toolbar">
        <button onclick="generatePythonCode()">生成 Python 代码</button>
        <button onclick="clearWorkspace()">清空工作区</button>
    </div>

    <!-- 代码输出区域 -->
    <pre id="codeOutput"></pre>

    <script>
        // 初始化 Blockly 工作区
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: `
                <xml>
                    <!-- 逻辑控制 -->
                    <category name="逻辑" colour="210">
                        <block type="controls_if"></block>
                        <block type="logic_compare"></block>
                        <block type="logic_operation"></block>
                    </category>

                    <!-- 数学运算 -->
                    <category name="数学" colour="230">
                        <block type="math_number"></block>
                        <block type="math_arithmetic"></block>
                        <!-- 自定义平方块 -->
                        <block type="math_square"></block>
                    </category>

                    <!-- 循环 -->
                    <category name="循环" colour="120">
                        <block type="controls_whileUntil"></block>
                        <block type="controls_repeat_ext"></block>
                    </category>
                </xml>
            `,
            theme: Blockly.Themes.Classic,  // 使用经典主题
            zoom: {
                controls: true,             // 显示缩放按钮
                wheel: true,                // 启用鼠标滚轮缩放
                startScale: 1.0,            // 初始缩放比例
                maxScale: 3,                // 最大放大倍数
                minScale: 0.3               // 最小缩小倍数
            }
        });

        // ========================
        // 自定义积木定义
        // ========================
        // 定义“平方”积木
        Blockly.Blocks['math_square'] = {
            init: function() {
                this.appendValueInput('NUM')
                    .setCheck('Number')
                    .appendField('计算平方');
                this.setOutput(true, 'Number');
                this.setColour(230);
                this.setTooltip('返回输入数值的平方');
            }
        };

        // ========================
        // Python 代码生成规则
        // ========================
        Blockly.Python['math_square'] = function(block) {
            const num = Blockly.Python.valueToCode(block, 'NUM', Blockly.Python.ORDER_EXPONENTIATION) || '0';
            return [`${num} ** 2`, Blockly.Python.ORDER_EXPONENTIATION];
        };

        // ========================
        // 功能函数
        // ========================
        // 生成 Python 代码
        function generatePythonCode() {
            const code = Blockly.Python.workspaceToCode(workspace);
            document.getElementById('codeOutput').textContent = code;
            
            // 可选：在控制台输出代码
            console.log("生成的 Python 代码:\n", code);
        }

        // 清空工作区
        function clearWorkspace() {
            workspace.clear();
            document.getElementById('codeOutput').textContent = '';
        }

        // ========================
        // 高级配置（可选）
        // ========================
        // 监听工作区变化（实时生成代码）
        workspace.addChangeListener((event) => {
            if (!event.isUiEvent) {
                generatePythonCode();
            }
        });
    </script>
</body>
</html>